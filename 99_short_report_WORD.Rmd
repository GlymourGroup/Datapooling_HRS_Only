---
title: "Simulation - Applied HRS Example"
author: "Peter Buto"
date: "`r Sys.Date()`"
output: word_document
---

```{r setup, include=FALSE}

# Clear Environment
rm(list=ls())
gc()

# Libraries
library("tidyverse")
library("flextable")

# Directories
dir <- list(
  NA_table   = file.path("~/Documents/DP_HRS_Only/Tables/")
)

# IMPORT DATA/TABLES
input <- list(
  regresult = readRDS(file.path(dir$NA_table, "MainResults.rds")),
  figure1 = readRDS(file.path(dir$NA_table, "Figure1.RDS")),
  nTracker = readRDS(file.path(dir$NA_table, "../nTracker.RDS")),
  tbl1 = readRDS(file.path(dir$NA_table, "Table1_List.RDS")),
  tbl_dist = readRDS("../../DP_HRS_Only/Tables/DistanceTable.rds"),
  tbl_means = readRDS("../../DP_HRS_Only/Tables/Matched_Cohort_Means.rds"),
  tbl_sds = readRDS("../../DP_HRS_Only/Tables/Matched_Cohort_SDs.rds")
)

outcomes <- c("GENHEALTH", "SYSTOLIC_BP")

# Clean other Regression Outputs
for(out in outcomes){
    input$regresult[[out]] <- input$regresult[[out]] %>% 
    rename(`No Mediators` = Instructions_NONE.R,
           `GS - No Mediators` = Instructions_NONE.R_TRUTH,
           `BMI` = Instructions_EXP.R,
           `GS - BMI` = Instructions_EXP.R_TRUTH,
           !!out := Instructions_OUT.R,
           !!paste0("GS - ",out) := Instructions_OUT.R_TRUTH,
           `Both Mediators` = Instructions_BOTH.R,
           `GS - Both Mediators` = Instructions_BOTH.R_TRUTH) %>%
    select(`No Mediators`, `GS - No Mediators`, 
           `BMI`, `GS - BMI`,
           out, paste0("GS - ",out),
           `Both Mediators`, `GS - Both Mediators`)

  # Sample Size Tracker
  input$nTracker[[out]] <- input$nTracker[[out]] %>% 
    rename(`No Mediators` = Instructions_NONE.R,
           `BMI` = Instructions_EXP.R,
           !!out := Instructions_OUT.R,
           `Both Mediators` = Instructions_BOTH.R) %>%
    select(`No Mediators`, `BMI`, out, `Both Mediators`)

# Table 1
  input$table1[[out]] <- cbind(input$tbl1[[out]]$Instructions_NONE.R, 
                               input$tbl1[[out]]$Instructions_EXP.R, 
                               input$tbl1[[out]]$Instructions_OUT.R, 
                               input$tbl1[[out]]$Instructions_BOTH.R)

# Table Distance
input$tbl_dist[[out]] <- input$tbl_dist[[out]] %>% 
  rename(`BMI` = Instructions_EXP.R,
         !!out := Instructions_OUT.R,
         `Both Mediators` = Instructions_BOTH.R)
}


# Diabetes Regression Output
input$regresult[["DIABETES"]] <- input$regresult[["DIABETES"]] %>% 
  select(Instructions_NONE.R, 
         Instructions_EXP.R, Instructions_OUT.R,Instructions_DIAB.R,
         Instructions_BOTH.R, Instructions_DIABA1c.R, Instructions_ALL3.R,
         Instructions_ALL3.R_TRUTH) %>%
  rename(`No Mediators` = Instructions_NONE.R,
         `BMI` = Instructions_EXP.R,
         `HbA1c` := Instructions_OUT.R,
         `Diabetes` = Instructions_DIAB.R,
         `BMI & HbA1c` = Instructions_BOTH.R,
         `Diabetes and HbA1c` = Instructions_DIABA1c.R,
         `BMI, HbA1c, DM` = Instructions_ALL3.R,
         `Gold Standard` = Instructions_ALL3.R_TRUTH) 

# Diabetes Sample Size Tracker
input$nTracker[["DIABETES"]] <- input$nTracker[["DIABETES"]] %>% 
  rename(`No Mediators` = Instructions_NONE.R,
         `BMI` = Instructions_EXP.R,
         `HbA1c` := Instructions_OUT.R,
         `Diabetes` = Instructions_DIAB.R,
         `BMI & HbA1c` = Instructions_BOTH.R,
         `Diabetes and HbA1c` = Instructions_DIABA1c.R,
         `BMI, HbA1c, DM` = Instructions_ALL3.R) %>%
  select(`No Mediators`, `BMI`, `HbA1c`, `Diabetes`, 
         `BMI & HbA1c`, `Diabetes and HbA1c`, `BMI, HbA1c, DM`)

# Diabetes Table 1
input$table1[["DIABETES"]] <- cbind(
  input$tbl1[["DIABETES"]]$Instructions_NONE.R,
  input$tbl1[["DIABETES"]]$Instructions_EXP.R,
  input$tbl1[["DIABETES"]]$Instructions_OUT.R,
  input$tbl1[["DIABETES"]]$Instructions_DIAB.R,
  input$tbl1[["DIABETES"]]$Instructions_BOTH.R,
  input$tbl1[["DIABETES"]]$Instructions_DIABA1c.R,
  input$tbl1[["DIABETES"]]$Instructions_ALL3.R
)


# Order the images so that it makes somewhat more sense
input$figure1$DIABETES$data$Model <- factor(input$figure1$DIABETES$data$Model,
                          levels = c("NONE", "EXP", "OUT", "DIAB", "BOTH", "DIABA1c", "ALL3"))

input$figure1$GENHEALTH$data$Model <-
  factor(input$figure1$GENHEALTH$data$Model,
         levels = c("NONE", "EXP", "OUT", "DIAB", "BOTH", "DIABA1c", "ALL3"))

input$figure1$SYSTOLIC_BP$data$Model <-
  factor(input$figure1$SYSTOLIC_BP$data$Model,
         levels = c("NONE", "EXP", "OUT", "DIAB", "BOTH", "DIABA1c", "ALL3"))

# ORder table means
input$tbl_means$DIABETES <- input$tbl_means$DIABETES %>% 
  select(Instructions_NONE.R_OLD,   Instructions_NONE.R_young,
         Instructions_EXP.R_OLD,    Instructions_EXP.R_young,
         Instructions_OUT.R_OLD,    Instructions_OUT.R_young,
         Instructions_DIAB.R_OLD,   Instructions_DIAB.R_young,
         Instructions_BOTH.R_OLD,   Instructions_BOTH.R_young,
         Instructions_DIABA1c.R_OLD,Instructions_DIABA1c.R_young,
         Instructions_ALL3.R_OLD,   Instructions_ALL3.R_young)

```

# Objective

Apply the data pooling approach (from the main text) to a real dataset. 

# Methods

## Cohort

The Health and Retirement Study (HRS) is a longitudinal study that surveys a representative sample of ~20,000 people in the United States with over 20 years of follow-up. We selected participants whose first visit was in 1992 and had follow-up visits in 1994, 2008, and 2018. 

We randomly assigned participants into an "older" cohort and a "younger" cohort. The "older" cohort uses data only from 2008 and later, masking the participants' data prior to then; the "younger" cohort uses data from 2008 and earlier, masking their data collected afterwards. 

## Matching Process

The simulation follows the steps taken in the main text. Briefly, the "older" cohort's baseline characteristics (assumed to be static such as race/ethnicity or sex) are exact matched to the "younger" cohort's baseline characteristics. As some characteristics can vary over time, the "older" cohort's baseline characteristics are then matched to time-varying characteristics of the "younger" cohort (e.g. religion, job status, marital status). The pairs created from these steps were then ranked based on how similar they were based on a difference in a set of continuous variables (e.g. those with closer BMI values were considered more similar). 

## Outcomes

To demonstrate the effect of different matching strategies, we selected three different outcomes (`History of Diabetes`, `Self-reported general health (1: Excellent - 5: Poor)`, `Systolic Blood Pressure`). We selected 2018 as the outcome year to have both component cohorts approximate longitudinal cohorts, where the younger cohort would represent age 50s to 66 and the older cohort would represent ages 66 to 77.

## Matching Sets 

For each outcome, we matched on core demographic features: sex, race/ethnicity, and age (within 5 years of each other). We then selected a minimal set of matching variables (total 12 matching sets): a model without mediator variables, a model matching only on a mediating exposure, a model matching only on a mediating outcome, and a model matching on both a mediating exposure and outcome. The mediator values were taken from 2008, the overlap year between the cohorts.

We tracked the sample size at each step of the process in the following tables.

\newpage

### Diabetes Sample Size Tracker
```{r, echo=FALSE}
input$nTracker$DIABETES %>% 
  rownames_to_column("Matching Step") %>%
  flextable() %>%
  set_caption(caption = "Diabetes Sample Size Tracker")
```

### General Health Sample Size Tracker
```{r, echo=FALSE}
input$nTracker$GENHEALTH %>% 
  rownames_to_column("Matching Step") %>%
  flextable() %>%
  set_caption(caption = "Self-Reported Health Sample Size Tracker")
```

### Systolic Blood Pressure Sample Size Tracker
```{r, echo=FALSE}
input$nTracker$SYSTOLIC_BP %>% 
  rownames_to_column("Matching Step") %>%
  flextable() %>%
  set_caption(caption = "Systolic Blood Pressure Sample Size Tracker")
```

\newpage

# Regression Results

We ran regressions in the pooled data with age, race/ethnicity, and sex as co-variates. For comparisons, we then ran the same analysis in those who were matched, labeled "Gold Standard". Results (Table 2) were largely similar between the two.

### Figure 1a. Diabetes Effect Estimates by Matching Set and Source
```{r, echo=FALSE}
suppressWarnings(print(input$figure1$DIABETES))
```

### Figure 1b. General Health Effect Estimates by Matching Set and Source
```{r, echo=FALSE}
suppressWarnings(print(input$figure1$GENHEALTH))
```

### Figure 1c. Systolic BP Effect Estimates by Matching Set and Source
```{r, echo=FALSE}
suppressWarnings(print(input$figure1$SYSTOLIC_BP))
```

\newpage 

# QC

Mean values for each distance variables were largely similar in the younger and older cohorts across each of the four matching sets. The mean values were most similar when mediator variables were excluded. 

Each of the following tables present a different outcome (diabetes, general health, systolic blood pressure) grouped together by the matching set (no mediators, BMI, outcome, both mediators). 

Units are in the mediator values (percentages for HbA1c, Count [1-5] for Self-Rated Health, and mmHg for SBP).

```{r, echo=FALSE}
input$tbl_means$DIABETES %>% 
  rownames_to_column("Mediating Variable") %>%
  flextable() %>%
  add_header_row(colwidths = c(1, 2,2,2,2, 2, 2, 2),
                 values = c("","No Mediators","BMI","HbA1c","Diabetes",
                            "BMI & HbA1c", "Diabetes & HbA1c",
                            "BMI, HbA1c, DM")) %>%
  align(i = 1, j = NULL, align = "center", part = "header") %>%
  set_caption(caption = "Diabetes - Comparison Mean Values: Old vs Young")
```

```{r, echo=FALSE}
input$tbl_means$GENHEALTH %>% 
  rownames_to_column("Mediating Variable") %>%
  flextable() %>%
  add_header_row(colwidths = c(1, 2,2,2,2),
                 values = c("","No Mediators","BMI","General Health",
                            "Both Mediators")) %>%
  align(i = 1, j = NULL, align = "center", part = "header") %>%
  set_caption(caption = "General Health - Comparison Mean Values: Old vs Young")
```

```{r, echo=FALSE}
input$tbl_means$SYSTOLIC_BP %>% 
  rownames_to_column("Mediating Variable") %>%
  flextable() %>%
  add_header_row(colwidths = c(1, 2,2,2,2),
                 values = c("","No Mediators","BMI","Systolic Blood Pressure",
                            "Both Mediators")) %>%
  align(i = 1, j = NULL, align = "center", part = "header") %>%
  set_caption(caption = "Systolic Blood Pressure - Comparison Mean Values: Old vs Young")
```


```{r, echo=FALSE}
input$tbl_dist$GENHEALTH %>% 
  rownames_to_column("Distance Variable") %>%
  flextable() %>%
  set_caption(caption = "General Health - Average difference in distance variables")
```

```{r, echo=FALSE}
input$tbl_dist$SYSTOLIC_BP %>% 
  rownames_to_column("Distance Variable") %>%
  flextable() %>%
  set_caption(caption = "Systolic Blood Pressure - Average difference in distance variables")
```
