---
title: "99 Simulation Applied Example"
author: "Peter Buto"
date: "`r Sys.Date()`"
output: 
  rmarkdown::pdf_document:
    fig_caption: yes
    includes:
      in_header: preamble-latex.tex
---

```{r setup, include=FALSE}

# Clear Environment
rm(list=ls())
gc()

# Libraries
library("tidyverse")
library("kableExtra")

# Directories
dir <- list(
  NA_table   = file.path("~/Documents/DP_HRS_Only/Tables/")
)

# IMPORT DATA/TABLES
input <- list(
  regresult = readRDS(file.path(dir$NA_table, "MainResults.rds")),
  figure1 = readRDS(file.path(dir$NA_table, "Figure1.RDS")),
  nTracker = readRDS(file.path(dir$NA_table, "../nTracker.RDS")),
  tbl1 = readRDS(file.path(dir$NA_table, "Table1_List.RDS")),
  tbl_dist = readRDS("../../DP_HRS_Only/Tables/DistanceTable.rds"),
  tbl_means = readRDS("../../DP_HRS_Only/Tables/Matched_Cohort_Means.rds"),
  tbl_sds = readRDS("../../DP_HRS_Only/Tables/Matched_Cohort_SDs.rds")
)

# Clean up data frames

outcomes <- c("DIABETES", "GENHEALTH", "SYSTOLIC_BP")

# Regression Output
for(out in outcomes){
  input$regresult[[out]] <- input$regresult[[out]] %>% 
    rename(`No Mediators` = Instructions_NONE.R,
           `GS - No Mediators` = Instructions_NONE.R_TRUTH,
           `BMI` = Instructions_EXP.R,
           `GS - BMI` = Instructions_EXP.R_TRUTH,
           !!out := Instructions_OUT.R,
           !!paste0("GS - ",out) := Instructions_OUT.R_TRUTH,
           `Both Mediators` = Instructions_BOTH.R,
           `GS - Both Mediators` = Instructions_BOTH.R_TRUTH) %>%
    select(`No Mediators`, `GS - No Mediators`, 
           `BMI`, `GS - BMI`,
           out, paste0("GS - ",out),
           `Both Mediators`, `GS - Both Mediators`
    )

  # Sample Size Tracker
  input$nTracker[[out]] <- input$nTracker[[out]] %>% 
    rename(`No Mediators` = Instructions_NONE.R,
           `BMI` = Instructions_EXP.R,
           !!out := Instructions_OUT.R,
           `Both Mediators` = Instructions_BOTH.R) %>%
    select(`No Mediators`, `BMI`, out, `Both Mediators`)

# Table 1
  input$table1[[out]] <- cbind(input$tbl1[[out]]$Instructions_NONE.R, 
                               input$tbl1[[out]]$Instructions_EXP.R, 
                               input$tbl1[[out]]$Instructions_OUT.R, 
                               input$tbl1[[out]]$Instructions_BOTH.R)

# Table Distance
input$tbl_dist[[out]] <- input$tbl_dist[[out]] %>% 
  rename(`BMI` = Instructions_EXP.R,
         !!out := Instructions_OUT.R,
         `Both Mediators` = Instructions_BOTH.R)
}
  

```

\newpage 

# Introduction

This analysis intends to respond to reviewer comments on the Simulation Paper. It applies to data pooling approach in the HRS sample where we know participants' values over a span of nearly 30 years. 

# Cohorts

We took the HRS cohort and selected participants whose first visit was in 1992 and had follow-up visits in 1994, 2008, and 2018. We then randomly split the HRS cohort into two cohorts and masked half of their data: 

  - "young cohort" uses data from waves from 2008 and earlier 
  - "older cohort" uses data from waves from 2008 and later

# Overview of matching strategy

Similar to the alcohol analysis, this analysis runs into the variable-sample size trade off. To circumvent the selection of variables, we started with a minimal set of variables to match on per Katrina's recommendations. 

In this case, we matched on core demographic features: sex, race/ethnicity, and age and only matched on `important` mediators: BMI (exposure) and General Health recorded (outcome) in 2008 (matching year). We tracked the sample size at each step of the process (Table 1)

\newpage

```{r, echo=FALSE}
input$nTracker$DIABETES %>% 
  kable(caption = "Sample Size Tracker") %>%
  kable_styling("striped",
                latex_options = c("HOLD_position"))
```


```{r, echo=FALSE}
input$nTracker$GENHEALTH %>% 
  kable(caption = "Sample Size Tracker") %>%
  kable_styling("striped",
                latex_options = c("HOLD_position"))
```


```{r, echo=FALSE}
input$nTracker$SYSTOLIC_BP %>% 
  kable(caption = "Sample Size Tracker") %>%
  kable_styling("striped",
                latex_options = c("HOLD_position"))
```

# Regression Results

We then ran regressions in the pooled data with age, race/ethnicity, and sex as co-variates. For comparisons, we then ran the same analysis in those who were matched, labeled "Gold Standard". Results (Table 2) were largely similar between the two.

### Figure 1a. Effect Estimates by Matching Set and Source
```{r, echo=FALSE}
suppressWarnings(print(input$figure1$DIABETES))
```


### Figure 1b. Effect Estimates by Matching Set and Source
```{r, echo=FALSE}
suppressWarnings(print(input$figure1$GENHEALTH))
```


### Figure 1c. Effect Estimates by Matching Set and Source
```{r, echo=FALSE}
suppressWarnings(print(input$figure1$SYSTOLIC_BP))
```

\newpage 
# QC

Mean values for the distance variables were largely the same in the younger and older cohorts across each of the four matching sets. 

```{r, echo=FALSE}
input$tbl_means$DIABETES %>% 
  kable(caption = "Mean Values: Old vs Young",
        "latex",
        booktabs = T,
        col.names = rep(c("Old","Young"),4)) %>%
  kable_styling("striped",
                latex_options = c("HOLD_position", "scale_down")) %>%
  add_header_above(c(" "=1, "Both Mediators" = 2, "DIABETES" = 2, "BMI" = 2, 
                     "No Mediators" = 2))
```

```{r, echo=FALSE}
input$tbl_means$GENHEALTH %>% 
  kable(caption = "Mean Values: Old vs Young",
        "latex",
        booktabs = T,
        col.names = rep(c("Old","Young"),4)) %>%
  kable_styling("striped",
                latex_options = c("HOLD_position", "scale_down")) %>%
  add_header_above(c(" "=1, "Both Mediators" = 2, "GENHEALTH" = 2, "BMI" = 2, 
                     "No Mediators" = 2))
```

```{r, echo=FALSE}
input$tbl_means$SYSTOLIC_BP %>% 
  kable(caption = "Mean Values: Old vs Young",
        "latex",
        booktabs = T,
        col.names = rep(c("Old","Young"),4)) %>%
  kable_styling("striped",
                latex_options = c("HOLD_position", "scale_down")) %>%
  add_header_above(c(" "=1, "Both Mediators" = 2, "SYSTOLIC_BP" = 2, "BMI" = 2, 
                     "No Mediators" = 2))
```


\newpage

The distance between the matched variables can be seen in the following table. 

```{r, echo=FALSE}
input$tbl_dist %>% 
  kable(caption = "Average distance in distance variables",
        "latex",
        booktabs = T) %>%
  kable_styling("striped",
                latex_options = c("HOLD_position"))
```

In previous attempts, there were concerns as to who was getting selected for the matches. We compare the demographics of those who were matched to those that were not among participants randomly assigned to the `Older` cohort and.

```{r, echo=FALSE}
input$table1 %>% 
  kable(caption = "Matched Vs Unmatched",
        "latex",
        booktabs = T,
        col.names = rep(c("Matched","Unmatched"),4)) %>%
  kable_styling("striped",
                latex_options = c("HOLD_position", "scale_down")) %>%
  add_header_above(c(" "=1, "No Mediators" = 2, "BMI" = 2, "GENHEALTH" = 2, 
                     "Both Mediators" = 2))
```

Interestingly females were more likely to get matched than males. Otherwise, those that were matched were largely similar to those who were unmatched with maybe the exception of age. I suspect this may be due to how HRS includes spouses that may either be significantly younger or older than the respondents. 




```{r, echo=FALSE}
input$regresult$DIABETES %>% 
  kable(caption = "Regression Results",
        "latex",
        booktabs = T,
        col.names = rep(c("Pooled","Truth"),4)) %>%
  kable_styling("striped",
                latex_options = c("HOLD_position", "scale_down")) %>%
  add_header_above(c(" "=1, "No Mediators" = 2, "BMI" = 2, "DIABETES" = 2, 
                     "Both Mediators" = 2))
```

```{r, echo=FALSE}
input$regresult$GENHEALTH %>% 
  kable(caption = "Regression Results",
        "latex",
        booktabs = T,
        col.names = rep(c("Pooled","Truth"),4)) %>%
  kable_styling("striped",
                latex_options = c("HOLD_position", "scale_down")) %>%
  add_header_above(c(" "=1, "No Mediators" = 2, "BMI" = 2, "DIABETES" = 2, 
                     "Both Mediators" = 2))
```

```{r, echo=FALSE}
input$regresult$SYSTOLIC_BP %>% 
  kable(caption = "Regression Results",
        "latex",
        booktabs = T,
        col.names = rep(c("Pooled","Truth"),4)) %>%
  kable_styling("striped",
                latex_options = c("HOLD_position", "scale_down")) %>%
  add_header_above(c(" "=1, "No Mediators" = 2, "BMI" = 2, "DIABETES" = 2, 
                     "Both Mediators" = 2))
```